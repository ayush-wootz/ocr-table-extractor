<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extract Drawing info</title>

  <!-- Handsontable CSS and JS from CDN -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@12.1.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/string-similarity@4.0.4/umd/string-similarity.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .secondary-button {
      background-color: #ccc;
      color: #333;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .secondary-button:hover {
      opacity: 0.8;
    }

    /* 2x2 Grid Layout - Reduced side margins */
    .upload-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 20px; /* Keep good separation between areas */
      margin-bottom: 20px;
      max-width: 500px; /* Increased from 350px to reduce side space */
      margin-left: auto;
      margin-right: auto;
    }

    .upload-area {
      position: relative;
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 8px; /* Further reduced padding */
      text-align: center;
      background: #fafafa;
      transition: all 0.3s ease;
      cursor: pointer;
      min-height: 55px; /* Further reduced height */
      max-height: 65px; /* Smaller max height */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      box-sizing: border-box; /* Ensure proper box sizing */
    }

    .upload-area:hover {
      border-color: #007bff;
      background: #f0f8ff;
    }

    .upload-area.dragover {
      border-color: #0056b3;
      background: #e6f3ff;
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
    }

    .upload-area.nearby {
      border-color: #28a745;
      background: #f0fff4;
      box-shadow: 0 0 8px rgba(40, 167, 69, 0.2);
    }

    .upload-area.has-file {
      border-color: #28a745;
      border-style: solid;
      background: #f8fff9;
    }

    .upload-label {
      font-weight: bold;
      margin-bottom: 2px; /* Further reduced margin */
      font-size: 0.8rem; /* Smaller font */
      line-height: 1.1; /* Tighter line height */
    }

    .required {
      color: #dc3545;
      margin-left: 2px;
    }

    .upload-area input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      z-index: 2;
    }

    .file-status {
      font-size: 0.65rem; /* Even smaller font */
      color: #28a745;
      font-weight: bold;
      margin-top: 2px; /* Reduced margin */
      line-height: 1; /* Tight line height */
    }

    /* highlight user-edited cells */
    .edited-cell {
      box-shadow: inset 0 0 0 2px orange !important;
    }
    
    #process-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 0;
      transition: background-color 0.3s ease;
    }
    
    #process-btn:hover:not(:disabled) {
      background: #0056b3;
    }

    #process-btn:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    
    #image-preview {
      margin: 20px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      min-height: 50px;
      position: relative;
    }
    
    #image-preview img {
      max-width: 300px;
      height: auto;
      display: block;
      margin-top: 10px;
    }

    .preview-remove-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 20px;
      height: 20px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .preview-remove-btn:hover {
      background: #c82333;
    }

    #image-preview.has-image .preview-remove-btn {
      display: flex;
    }
    
    select {
      padding: 5px 10px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    /* Responsive design for mobile */
    @media (max-width: 600px) {
      .upload-grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, 1fr);
      }
    }
   
  </style>
</head>
<body>
  <div class="container">
    <h1>Extract Drawing info</h1>

    <select id="mode-select">
      <option value="table" selected>Column-by-Column Table Extract</option>
      <option value="quick">Quick Text Copy (Paragraph)</option>
    </select>

    <h3 style="margin-bottom: 15px;">Upload Column Data</h3>
    
    <div class="upload-grid">
      <!-- Part Number -->
      <div class="upload-area" id="area-partNumber" data-column="partNumber">
        <div class="upload-label">Part Number <span class="required">*</span></div>
        <input type="file" id="upload-partnumber" accept="image/*" />
        <div class="file-status" id="status-partNumber" style="display: none;">‚úì Uploaded</div>
      </div>

      <!-- Quantity -->
      <div class="upload-area" id="area-quantity" data-column="quantity">
        <div class="upload-label">Quantity <span class="required">*</span></div>
        <input type="file" id="upload-quantity" accept="image/*" />
        <div class="file-status" id="status-quantity" style="display: none;">‚úì Uploaded</div>
      </div>

      <!-- Description -->
      <div class="upload-area" id="area-description" data-column="description">
        <div class="upload-label">Description</div>
        <input type="file" id="upload-description" accept="image/*" />
        <div class="file-status" id="status-description" style="display: none;">‚úì Uploaded</div>
      </div>

      <!-- Material -->
      <div class="upload-area" id="area-material" data-column="material">
        <div class="upload-label">Material</div>
        <input type="file" id="upload-material" accept="image/*" />
        <div class="file-status" id="status-material" style="display: none;">‚úì Uploaded</div>
      </div>
    </div>

    <div id="image-preview">
      <button class="preview-remove-btn" onclick="clearPreview()">√ó</button>
    </div>
    <button id="process-btn">Process Image</button>

    <div id="result-container"></div>
    <button id="download-btn" class="secondary-button" style="display: none;">Download as CSV</button>
    <div id="hot" style="width: 100%; height: 400px; display: none;"></div>
    
  </div>

  <script>

    // :-----------------------------------------:
    //  Column key ‚Üí display title mapping
    // :-----------------------------------------:
    const COLUMN_TITLES = {
      PartNumber:            "Part Number",
      Quantity:              "Quantity",
      Description:           "Description",
      Material:              "Material",
      "Matched Childpart":   "Matched Drawing Number",
      Type:                  "Type"
    };
    
    let spreadsheetData = [];
    let columnsList = [];
    let columnCount = 0;
    let hot;

    const uploads = {
      partNumber: document.getElementById("upload-partnumber"),
      description: document.getElementById("upload-description"),
      quantity: document.getElementById("upload-quantity"),
      material: document.getElementById("upload-material")
    };

    const columnOrder = [
      { id: "partNumber", label: "PartNumber" },
      { id: "description", label: "Description" },
      { id: "quantity", label: "Quantity" },
      { id: "material", label: "Material" }
    ];

    const API_URL = 'https://ocr-table-extractor.onrender.com';

    window.addEventListener("DOMContentLoaded", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const project = urlParams.get("project");
      const partNumber = urlParams.get("part");
      const parentDrgNum = urlParams.get("parentdrgnum");

      if (!project || !partNumber || !parentDrgNum) {
        alert("Missing query params: project or part or parent drawing number");
        return;
      }

      try {
        const response = await fetch("https://ocr-table-extractor.onrender.com/fetch-drawings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ project, part: partNumber })
        });
        const data = await response.json();
        console.log("‚úÖ Filtered drawing data from Glide via backend:", data.rows);
        window.childParts = data.rows;
      } catch (err) {
        console.error("‚ùå Error fetching drawing data:", err);
      }
    });

    function textRenderer(instance, td, row, col, prop, value, cellProperties) {
      Handsontable.renderers.TextRenderer.apply(this, arguments);
      const rowData = instance.getSourceDataAtRow(row);
      if (rowData && rowData[prop] && typeof rowData[prop] === 'object') {
        const cellData = rowData[prop];
        td.innerText = cellData.text;
        const conf = parseFloat(cellData.confidence);
        if (conf >= 0.9) td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
        else if (conf >= 0.7) td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
        else td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
      } else {
        td.innerText = value;
      }
    }

    function renderSpreadsheet() {
      // ensure the new column is in the right spot
      if (columnsList.includes("Matched Childpart") && !columnsList.includes("Type")) {
        const idx = columnsList.indexOf("Matched Childpart");
        columnsList.splice(idx + 1, 0, "Type");
      }
      
      const columns = [];
      const colHeaders = [];
    
      columnsList.forEach(key => {
        const title = COLUMN_TITLES[key] || key;
        const isMatched = key === 'Matched Childpart';
        const isType    = key === "Type";
        const drawingOptions = Array.isArray(window.childParts)
          ? window.childParts.map(p => p.drawingNumber || '')
          : [];
    
        columns.push({
          // 1) editor & data binding
          data:       (isMatched || isType) ? key : `${key}.text`,
          title,
          type:       (isMatched || isType) ? 'dropdown' : 'text',
          editor:     (isMatched || isType) ? 'dropdown' : 'text',
          source:     isMatched ? drawingOptions : isType ? ['Child Part','BO'] : undefined,
          strict:     (isMatched || isType),
          allowInvalid: false,
    
          // 2) custom renderer for OCR columns
          renderer: (isMatched || isType)
            ? undefined
            : function(hotInst, td, row, col, prop, value, cellProps) {
                // first draw the text
                Handsontable.renderers.TextRenderer.apply(this, arguments);
    
                // then pull the original object back out
                const rowData = hotInst.getSourceDataAtRow(row);
                const cellObj = rowData[key];  // the {text, confidence} you stored
    
                if (cellObj && typeof cellObj === 'object') {
                  const conf = parseFloat(cellObj.confidence);
                  if (conf >= 0.9) {
                    td.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
                  } else if (conf >= 0.7) {
                    td.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
                  } else {
                    td.style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
                  }
                }
              }
        });
    
        colHeaders.push(key);
      });
    
      const container = document.getElementById('hot');
      container.style.display = 'block';
    
      if (hot) hot.destroy();
      hot = new Handsontable(container, {
        data: spreadsheetData,
        columns,
        colHeaders,
        rowHeaders: true,
        minSpareRows: 1,
        contextMenu: ['remove_row','copy','paste'],
        licenseKey: 'non-commercial-and-evaluation'
      });
      
      // after you create `hot` in renderSpreadsheet():
      hot.addHook('afterChange', (changes, source) => {
        // only care about real user edits
        if (source !== 'edit' || !changes) return;
      
        changes.forEach(([row, prop, oldValue, newValue]) => {
          // skip if value didn't actually change
          if (oldValue === newValue) return;
      
          const col = hot.propToCol(prop);
          // mark this cell as edited
          hot.setCellMeta(row, col, 'className', 'edited-cell');
        });
      
        // re-render so every flagged cell gets the CSS
        hot.render();
      });
    }

    function addColumn(newColumnData, label) {
      columnsList.push(label);
      if (label === "PartNumber" && !columnsList.includes("Matched Childpart")) {
        columnsList.push("Matched Childpart");
        columnsList.push("Type");
      }

      for (let i = 0; i < newColumnData.length; i++) {
        const text = newColumnData[i].text || "";
        const confidence = newColumnData[i].confidence || 0;
        if (!spreadsheetData[i]) spreadsheetData[i] = {};
        spreadsheetData[i][label] = { text, confidence };

        if (label === "PartNumber" && window.childParts?.length) {
          const drawingNumbers = window.childParts.map(p => p.drawingNumber || "");
          const result = stringSimilarity.findBestMatch(text, drawingNumbers);
          const matchText = result.bestMatch.rating > 0.5 ? result.bestMatch.target : "";
          // spreadsheetData[i]["Matched Childpart"] = { text: matchText, confidence: result.bestMatch.rating };
          spreadsheetData[i]["Matched Childpart"] = matchText; // Just plain string
          // Type cell: auto‚Äêpopulate
          // only set Type if there's actually a PartNumber
          if (text) {
            spreadsheetData[i]["Type"] = matchText ? "Child Part" : "BO";
          }
        }

        for (let i = newColumnData.length; i < spreadsheetData.length; i++) {
          // only if there's really a PartNumber in that row
          const part = spreadsheetData[i]["PartNumber"]?.text;
          if (part) {
            const hasMatch = spreadsheetData[i]["Matched Childpart"]?.text;
            spreadsheetData[i]["Type"] = hasMatch ? "Child Part" : "BO";
          }
       }
      }

      renderSpreadsheet();
    }

    document.getElementById("process-btn").onclick = async function () {
      spreadsheetData = [];
      columnsList = [];
      columnCount = 0;

      for (const col of columnOrder) {
        const fileInput = uploads[col.id];
        const file = fileInput.files[0];
        if (!file && (col.id === "partNumber" || col.id === "quantity")) {
          alert(`Please upload an image for ${col.label}`);
          return;
        }
        if (!file) continue;

        const formData = new FormData();
        formData.append("image", file);
        formData.append("mode", "table");

        // Log & tell the backend which column we're OCR'ing
        console.log(`üöÄ OCR request for column: ${col.id}`);
        formData.append("column", col.id);

        const response = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        if (data.table) {
          addColumn(data.table, col.label);
        }
      }
    };

    const previewContainer = document.getElementById("image-preview");

    // Drag and drop functionality
    let dragCounter = 0;

    // Get nearest upload area based on mouse position
    function getNearbyUploadArea(x, y, threshold = 100) {
      const areas = document.querySelectorAll('.upload-area');
      let closestArea = null;
      let minDistance = threshold;
      
      areas.forEach(area => {
        const rect = area.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const distance = Math.sqrt(
          Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2)
        );
        
        if (distance < minDistance) {
          minDistance = distance;
          closestArea = area;
        }
      });
      
      return closestArea;
    }

    // Clear all nearby highlights
    function clearNearbyHighlights() {
      document.querySelectorAll('.upload-area').forEach(area => {
        area.classList.remove('nearby');
      });
    }

    // Global drag events for vicinity detection
    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
      dragCounter++;
    });

    document.addEventListener('dragover', function(e) {
      e.preventDefault();
      
      // Check if we're dragging files
      const hasFiles = e.dataTransfer && (
        e.dataTransfer.types.includes('Files') || 
        e.dataTransfer.types.includes('application/x-moz-file')
      );
      
      if (hasFiles) {
        const nearbyArea = getNearbyUploadArea(e.clientX, e.clientY);
        
        clearNearbyHighlights();
        if (nearbyArea && !nearbyArea.classList.contains('dragover')) {
          nearbyArea.classList.add('nearby');
        }
      }
    });

    document.addEventListener('dragleave', function(e) {
      dragCounter--;
      if (dragCounter <= 0) {
        dragCounter = 0;
        clearNearbyHighlights();
      }
    });

    document.addEventListener('drop', function(e) {
      dragCounter = 0;
      clearNearbyHighlights();
    });

    // Setup individual upload areas
    document.querySelectorAll('.upload-area').forEach(area => {
      const col = area.dataset.column;
      const input = uploads[col];

      // Click to upload
      area.addEventListener('click', function(e) {
        input.click();
      });

      // File input change
      input.addEventListener('change', function() {
        if (input.files[0]) {
          area.classList.add('has-file');
          document.getElementById(`status-${col}`).style.display = 'block';
          
          // Store which column was last uploaded for the clear function
          previewContainer.dataset.lastColumn = col;
          
          // Update preview and button state
          const columnName = area.querySelector('.upload-label').textContent.trim();
          showImagePreview(input.files[0], columnName);
          updateProcessButton();
        }
      });

      // Drag events for individual areas
      area.addEventListener('dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        area.classList.add('dragover');
        clearNearbyHighlights();
      });

      area.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
      });

      area.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        area.classList.remove('dragover');
      });

      area.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        area.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
          input.files = e.dataTransfer.files;
          area.classList.add('has-file');
          document.getElementById(`status-${col}`).style.display = 'block';
          
          // Store which column was last uploaded for the clear function
          previewContainer.dataset.lastColumn = col;
          
          // Update preview and button state
          const columnName = area.querySelector('.upload-label').textContent.trim();
          showImagePreview(e.dataTransfer.files[0], columnName);
          updateProcessButton();
        }
      });
    });

    // Enable/disable process button based on required files
    function updateProcessButton() {
      const hasRequired = uploads.partNumber.files.length > 0 && uploads.quantity.files.length > 0;
      document.getElementById("process-btn").disabled = !hasRequired;
    }

    // Initialize button state
    updateProcessButton();

    // Preview function with remove button
    function showImagePreview(file, label) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const img = new Image();
        img.src = event.target.result;
        img.style.maxWidth = "300px";
        img.alt = label;
    
        // Clear previous preview and insert new one
        previewContainer.innerHTML = `<button class="preview-remove-btn" onclick="clearPreview()">√ó</button><strong>${label}</strong><br>`;
        previewContainer.appendChild(img);
        previewContainer.classList.add('has-image');
      };
      reader.readAsDataURL(file);
    }

    // Function to clear preview and reset corresponding upload
    function clearPreview() {
      previewContainer.innerHTML = '<button class="preview-remove-btn" onclick="clearPreview()">√ó</button>';
      previewContainer.classList.remove('has-image');
      
      // Find and clear the last uploaded file
      const lastUploadedColumn = previewContainer.dataset.lastColumn;
      if (lastUploadedColumn) {
        const input = uploads[lastUploadedColumn];
        if (input) {
          input.value = '';
          document.getElementById(`area-${lastUploadedColumn}`).classList.remove('has-file');
          document.getElementById(`status-${lastUploadedColumn}`).style.display = 'none';
          updateProcessButton();
        }
      }
    }

    // Make clearPreview globally accessible
    window.clearPreview = clearPreview;
    
    // Attach onchange handlers (keeping original preview functionality)
    uploads.partNumber.addEventListener("change", (e) => {
      if (e.target.files[0]) {
        previewContainer.dataset.lastColumn = 'partNumber';
        showImagePreview(e.target.files[0], "PartNumber Preview");
        updateProcessButton();
      }
    });
    uploads.quantity.addEventListener("change", (e) => {
      if (e.target.files[0]) {
        previewContainer.dataset.lastColumn = 'quantity';
        showImagePreview(e.target.files[0], "Quantity Preview");
        updateProcessButton();
      }
    });
    uploads.description.addEventListener("change", (e) => {
      if (e.target.files[0]) {
        previewContainer.dataset.lastColumn = 'description';
        showImagePreview(e.target.files[0], "Description Preview");
      }
    });
    uploads.material.addEventListener("change", (e) => {
      if (e.target.files[0]) {
        previewContainer.dataset.lastColumn = 'material';
        showImagePreview(e.target.files[0], "Material Preview");
      }
    });
    
  </script>
</body>
</html>
